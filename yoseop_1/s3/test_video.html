<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë””ì˜¤ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 4px; }
        .record-btn { background: #dc2626; color: white; }
        .stop-btn { background: #6b7280; color: white; }
        .upload-btn { background: #2563eb; color: white; }
        video { width: 100%; max-width: 500px; background: #000; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .info { background: #dbeafe; color: #1d4ed8; }
    </style>
</head>
<body>
    <h1>ğŸ¥ S3 ë¹„ë””ì˜¤ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    
    <!-- 1. ë…¹í™” í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h2>1ï¸âƒ£ ë…¹í™” í…ŒìŠ¤íŠ¸</h2>
        <button id="startRecord" class="record-btn">ğŸ”´ ë…¹í™” ì‹œì‘</button>
        <button id="stopRecord" class="stop-btn" disabled>â¹ï¸ ë…¹í™” ì •ì§€</button>
        <div id="recordStatus" class="status info">ì¤€ë¹„ ì™„ë£Œ</div>
        <video id="preview" autoplay muted style="transform: scaleX(-1);"></video>
    </div>

    <!-- 2. ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h2>2ï¸âƒ£ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h2>
        <button id="uploadBtn" class="upload-btn" disabled>ğŸ“¤ ì—…ë¡œë“œí•˜ê¸°</button>
        <div id="uploadStatus" class="status info">ë…¹í™” ì™„ë£Œ í›„ ì—…ë¡œë“œ ê°€ëŠ¥</div>
        <div id="uploadProgress"></div>
    </div>

    <!-- 3. ì¬ìƒ í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h2>3ï¸âƒ£ ì¬ìƒ í…ŒìŠ¤íŠ¸</h2>
        <button id="loadVideo" class="upload-btn">ğŸ¬ ë¹„ë””ì˜¤ ë¡œë“œ</button>
        <div id="playStatus" class="status info">ì—…ë¡œë“œ ì™„ë£Œ í›„ ì¬ìƒ ê°€ëŠ¥</div>
        <video id="player" controls style="display: none;"></video>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let mediaId = null;
        const INTERVIEW_ID = 999; // í…ŒìŠ¤íŠ¸ìš© ID

        // í† í° (ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸í•´ì„œ ë°›ì•„ì•¼ í•¨)
        const TOKEN = localStorage.getItem('token') || 'test-token';

        // 1. ë…¹í™” ê¸°ëŠ¥
        document.getElementById('startRecord').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('preview').srcObject = stream;
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    document.getElementById('recordStatus').innerHTML = 
                        '<span class="success">âœ… ë…¹í™” ì™„ë£Œ! ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>';
                    document.getElementById('uploadBtn').disabled = false;
                    
                    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('startRecord').disabled = true;
                document.getElementById('stopRecord').disabled = false;
                document.getElementById('recordStatus').innerHTML = 
                    '<span class="info">ğŸ”´ ë…¹í™” ì¤‘...</span>';

            } catch (error) {
                document.getElementById('recordStatus').innerHTML = 
                    `<span class="error">âŒ ë…¹í™” ì‹¤íŒ¨: ${error.message}</span>`;
            }
        });

        document.getElementById('stopRecord').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('startRecord').disabled = false;
                document.getElementById('stopRecord').disabled = true;
            }
        });

        // 2. ì—…ë¡œë“œ ê¸°ëŠ¥
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (recordedChunks.length === 0) return;

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            document.getElementById('uploadStatus').innerHTML = 
                '<span class="info">ğŸ“¤ ì—…ë¡œë“œ ì¤‘...</span>';

            try {
                // 1. ì—…ë¡œë“œ URL ìš”ì²­
                const response = await fetch('/video/upload-url', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        interview_id: INTERVIEW_ID,
                        file_name: `test-${Date.now()}.webm`
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }

                const { upload_url, media_id } = await response.json();
                mediaId = media_id;
                
                // 2. S3ì— ì§ì ‘ ì—…ë¡œë“œ
                const uploadResponse = await fetch(upload_url, {
                    method: 'PUT',
                    body: blob
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`S3 ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadResponse.status}`);
                }
                
                // 3. ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
                await fetch(`/video/complete/${media_id}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                document.getElementById('uploadStatus').innerHTML = 
                    `<span class="success">âœ… ì—…ë¡œë“œ ì™„ë£Œ! Media ID: ${media_id}</span>`;
                document.getElementById('loadVideo').disabled = false;
                
            } catch (error) {
                document.getElementById('uploadStatus').innerHTML = 
                    `<span class="error">âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}</span>`;
            }
        });

        // 3. ì¬ìƒ ê¸°ëŠ¥
        document.getElementById('loadVideo').addEventListener('click', async () => {
            try {
                const response = await fetch(`/video/play/${INTERVIEW_ID}`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                if (!response.ok) {
                    throw new Error(`ì¬ìƒ URL ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const { play_url } = await response.json();
                
                const player = document.getElementById('player');
                player.src = play_url;
                player.style.display = 'block';
                
                document.getElementById('playStatus').innerHTML = 
                    '<span class="success">âœ… ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ! ì¬ìƒí•´ë³´ì„¸ìš”.</span>';
                
            } catch (error) {
                document.getElementById('playStatus').innerHTML = 
                    `<span class="error">âŒ ì¬ìƒ ì‹¤íŒ¨: ${error.message}</span>`;
            }
        });
    </script>
</body>
</html>