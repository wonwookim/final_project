<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비디오 시스템 테스트</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 4px; }
        .record-btn { background: #dc2626; color: white; }
        .stop-btn { background: #6b7280; color: white; }
        .upload-btn { background: #2563eb; color: white; }
        video { width: 100%; max-width: 500px; background: #000; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .info { background: #dbeafe; color: #1d4ed8; }
    </style>
</head>
<body>
    <h1>🎥 S3 비디오 시스템 테스트</h1>
    
    <!-- 1. 녹화 테스트 -->
    <div class="section">
        <h2>1️⃣ 녹화 테스트</h2>
        <button id="startRecord" class="record-btn">🔴 녹화 시작</button>
        <button id="stopRecord" class="stop-btn" disabled>⏹️ 녹화 정지</button>
        <div id="recordStatus" class="status info">준비 완료</div>
        <video id="preview" autoplay muted style="transform: scaleX(-1);"></video>
    </div>

    <!-- 2. 업로드 테스트 -->
    <div class="section">
        <h2>2️⃣ 업로드 테스트</h2>
        <button id="uploadBtn" class="upload-btn" disabled>📤 업로드하기</button>
        <div id="uploadStatus" class="status info">녹화 완료 후 업로드 가능</div>
        <div id="uploadProgress"></div>
    </div>

    <!-- 3. 재생 테스트 -->
    <div class="section">
        <h2>3️⃣ 재생 테스트</h2>
        <button id="loadVideo" class="upload-btn">🎬 비디오 로드</button>
        <div id="playStatus" class="status info">업로드 완료 후 재생 가능</div>
        <video id="player" controls style="display: none;"></video>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let mediaId = null;
        const INTERVIEW_ID = 999; // 테스트용 ID

        // 토큰 (실제로는 로그인해서 받아야 함)
        const TOKEN = localStorage.getItem('token') || 'test-token';

        // 1. 녹화 기능
        document.getElementById('startRecord').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('preview').srcObject = stream;
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    document.getElementById('recordStatus').innerHTML = 
                        '<span class="success">✅ 녹화 완료! 업로드 가능합니다.</span>';
                    document.getElementById('uploadBtn').disabled = false;
                    
                    // 스트림 정리
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('startRecord').disabled = true;
                document.getElementById('stopRecord').disabled = false;
                document.getElementById('recordStatus').innerHTML = 
                    '<span class="info">🔴 녹화 중...</span>';

            } catch (error) {
                document.getElementById('recordStatus').innerHTML = 
                    `<span class="error">❌ 녹화 실패: ${error.message}</span>`;
            }
        });

        document.getElementById('stopRecord').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('startRecord').disabled = false;
                document.getElementById('stopRecord').disabled = true;
            }
        });

        // 2. 업로드 기능
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (recordedChunks.length === 0) return;

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            document.getElementById('uploadStatus').innerHTML = 
                '<span class="info">📤 업로드 중...</span>';

            try {
                // 1. 업로드 URL 요청
                const response = await fetch('/video/upload-url', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        interview_id: INTERVIEW_ID,
                        file_name: `test-${Date.now()}.webm`
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API 오류: ${response.status}`);
                }

                const { upload_url, media_id } = await response.json();
                mediaId = media_id;
                
                // 2. S3에 직접 업로드
                const uploadResponse = await fetch(upload_url, {
                    method: 'PUT',
                    body: blob
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`S3 업로드 실패: ${uploadResponse.status}`);
                }
                
                // 3. 업로드 완료 처리
                await fetch(`/video/complete/${media_id}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                document.getElementById('uploadStatus').innerHTML = 
                    `<span class="success">✅ 업로드 완료! Media ID: ${media_id}</span>`;
                document.getElementById('loadVideo').disabled = false;
                
            } catch (error) {
                document.getElementById('uploadStatus').innerHTML = 
                    `<span class="error">❌ 업로드 실패: ${error.message}</span>`;
            }
        });

        // 3. 재생 기능
        document.getElementById('loadVideo').addEventListener('click', async () => {
            try {
                const response = await fetch(`/video/play/${INTERVIEW_ID}`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                if (!response.ok) {
                    throw new Error(`재생 URL 요청 실패: ${response.status}`);
                }

                const { play_url } = await response.json();
                
                const player = document.getElementById('player');
                player.src = play_url;
                player.style.display = 'block';
                
                document.getElementById('playStatus').innerHTML = 
                    '<span class="success">✅ 비디오 로드 완료! 재생해보세요.</span>';
                
            } catch (error) {
                document.getElementById('playStatus').innerHTML = 
                    `<span class="error">❌ 재생 실패: ${error.message}</span>`;
            }
        });
    </script>
</body>
</html>