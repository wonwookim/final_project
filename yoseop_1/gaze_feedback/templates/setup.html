<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì ‘ í™˜ê²½ ì„¤ì •</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 420px;
            width: 95%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 0 32px 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0 18px 0;
            text-align: center;
            width: 100%;
        }
        .header h1 { font-size: 2.1em; margin-bottom: 8px; }
        .header p { font-size: 1em; opacity: 0.93; }
        .instruction {
            width: 92%;
            margin: 18px auto 10px auto;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 13px 15px;
            border-radius: 7px;
            min-height: 48px;
            display: flex;
            align-items: center;
            font-size: 1.08em;
        }
        .video-container {
            margin: 0 auto;
            width: 96%;
            max-width: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            background: #000;
            display: flex;
            justify-content: center;
            aspect-ratio: 4/3;
            min-height: 300px;
            min-width: 400px;
        }
        .video-feed {
            width: 100%;
            height: 100%;
            max-width: 400px;
            max-height: 300px;
            aspect-ratio: 4/3;
            object-fit: cover;
            display: block;
            background: #222;
        }
        .control-panel {
            width: 92%;
            margin: 20px auto 0 auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px 18px 18px 18px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            align-items: center;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-top: 3px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.08em;
            width: 95%;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.setting {
            background: #fff3cd;
            color: #856404;
        }
        .status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ¯ ë©´ì ‘ í™˜ê²½ ì„¤ì •</h1>
        <p>ì‹œì„  ì¶”ì ì„ ìœ„í•œ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤</p>
    </div>
    <!-- ì•Œë¦¼ ë©”ì‹œì§€: ì¹´ë©”ë¼ ìœ„ -->
    <div class="instruction" id="step-instruction">
        í™˜ê²½ ì„¸íŒ… ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”
    </div>
    <!-- ì¹´ë©”ë¼: ì¤‘ì•™ -->
    <div class="video-container">
        <img id="video-feed" src="{{ url_for('video_feed') }}" class="video-feed" alt="ì¹´ë©”ë¼ ë¡œë”© ì¤‘...">
    </div>
    <!-- ë²„íŠ¼, ìƒíƒœ: ì¹´ë©”ë¼ ì•„ë˜ -->
    <div class="control-panel">
        <div class="status ready" id="status">âœ… ì„¤ì • ì¤€ë¹„ ì™„ë£Œ</div>
        <button class="btn btn-primary" id="setup-btn" onclick="startSetting()">ğŸ¯ ë©´ì ‘ í™˜ê²½ ì„¸íŒ…</button>
        <button class="btn btn-success" id="start-btn" onclick="startInterview()" disabled>ğŸš€ ë©´ì ‘ ì‹œì‘</button>
    </div>
</div>

<script>
let isSettingComplete = false;
let statusCheckInterval = null;

// ë‹¨ê³„ë³„ ì•Œë¦¼ ë©”ì‹œì§€ (ë°±ì—”ë“œì—ì„œ phaseë¡œ ìƒíƒœ ì²´í¬í•  ë•Œ ë°”ê¿”ì¤Œ)
const phaseInstructions = {
    'ready': "í™˜ê²½ ì„¸íŒ… ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”",
    'top_left': "3ì´ˆ í›„ ì¢Œìƒë‹¨ì„ 3ì´ˆ ë™ì•ˆ ì‘ì‹œí•˜ì„¸ìš”",
    'bottom_left': "3ì´ˆ í›„ ì¢Œí•˜ë‹¨ì„ 3ì´ˆ ë™ì•ˆ ì‘ì‹œí•˜ì„¸ìš”",
    'top_right': "3ì´ˆ í›„ ìš°ìƒë‹¨ì„ 3ì´ˆ ë™ì•ˆ ì‘ì‹œí•˜ì„¸ìš”",
    'bottom_right': "3ì´ˆ í›„ ìš°í•˜ë‹¨ì„ 3ì´ˆ ë™ì•ˆ ì‘ì‹œí•˜ì„¸ìš”",
    'completed': "ë©´ì ‘ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”"
};

function setStepInstruction(phase) {
    const instructionEl = document.getElementById('step-instruction');
    // phaseì— ë”°ë¼ ë©”ì‹œì§€ ì„¸íŒ…
    if (phaseInstructions[phase]) {
        instructionEl.textContent = phaseInstructions[phase];
    } else {
        instructionEl.textContent = "í™˜ê²½ ì„¸íŒ… ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”";
    }
}

function startSetting() {
    fetch('/start_setting', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('status').textContent = 'â³ í™˜ê²½ ì„¤ì • ì¤‘...';
                document.getElementById('status').className = 'status setting';
                document.getElementById('setup-btn').disabled = true;
                setStepInstruction('top_left'); // ì²« ì•ˆë‚´ëŠ” top_leftë¡œ ì‹œì‘(ì˜ˆì‹œ, í•„ìš”ì‹œ ë°±ì—”ë“œì— ë§ê²Œ ìˆ˜ì •)
                startStatusCheck();
            }
        })
        .catch(() => alert('âŒ í™˜ê²½ ì„¤ì • ì‹œì‘ ì‹¤íŒ¨'));
}

function startStatusCheck() {
    statusCheckInterval = setInterval(() => {
        fetch('/get_setting_status', { method: 'GET' })
            .then(res => res.json())
            .then(data => {
                // phase ì •ë³´ì— ë”°ë¼ ì•ˆë‚´ë¬¸êµ¬ ë³€ê²½
                setStepInstruction(data.phase);
                if (data.phase === 'completed' && !data.is_setting) {
                    clearInterval(statusCheckInterval);
                    isSettingComplete = true;
                    document.getElementById('status').textContent = 'âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ!';
                    document.getElementById('status').className = 'status completed';
                    document.getElementById('setup-btn').disabled = false;
                    document.getElementById('start-btn').disabled = false;
                }
            })
            .catch(err => {
                console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
            });
    }, 500);
}

function startInterview() {
    if (!isSettingComplete) {
        alert('âš ï¸ ë¨¼ì € í™˜ê²½ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
        return;
    }
    window.location.href = '/interview';
}
document.getElementById('video-feed').addEventListener('error', function() {
    alert('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
});
// í˜ì´ì§€ ë¡œë”© ì‹œ ì•ˆë‚´ ì´ˆê¸°í™”
setStepInstruction('ready');
</script>
</body>
</html>
