#!/usr/bin/env python3
"""
ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ ë¹Œë”
service.pyì—ì„œ ë¶„ë¦¬ëœ ëª¨ë“  í”„ë¡¬í”„íŠ¸ ê´€ë ¨ ë¡œì§ì„ ë‹´ë‹¹
"""

from typing import Dict, List, Any
from ..shared.constants import GPT_MODEL


class InterviewerPromptBuilder:
    """ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ ìƒì„±ì„ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤"""
    
    def __init__(self):
        # ë©´ì ‘ê´€ë³„ í™•ì¥ëœ ì£¼ì œ í’€ êµ¬ì¶•
        self.expanded_topic_pools = self._build_expanded_topic_pools()
        # ë©´ì ‘ê´€ë³„ í˜ë¥´ì†Œë‚˜ ì •ì˜
        self.interviewer_personas = self._build_interviewer_personas()
    
    def _build_expanded_topic_pools(self) -> Dict[str, List[str]]:
        """ë©´ì ‘ê´€ë³„ í™•ì¥ëœ ì£¼ì œ í’€ (ê¸°ì¡´ 5ê°œ â†’ 15ê°œ)"""
        return {
            'HR': [
                'ê°€ì¹˜ê´€_ì‹ ë…ì²´ê³„', 'ì„±ì¥_í•™ìŠµë™ê¸°', 'ê°ˆë“±_í•´ê²°ê²½í—˜', 'ìŠ¤íŠ¸ë ˆìŠ¤_ì••ë°•ëŒ€ì²˜',
                'íŒ€ì›Œí¬_ìƒí˜¸ì¡´ì¤‘', 'ì‹¤íŒ¨_ê·¹ë³µê³¼ì •', 'ì˜ì‚¬ì†Œí†µ_ê³µê°ëŠ¥ë ¥', 'ë³€í™”_ì ì‘ë ¥',
                'ìœ¤ë¦¬_ë„ë•ì íŒë‹¨', 'ì¥ê¸°_ì»¤ë¦¬ì–´ë¹„ì „', 'ìê¸°ì„±ì°°_í”¼ë“œë°±ìˆ˜ìš©', 'ì±•ì„ê°_ì£¼ì¸ì˜ì‹',
                'ë‹¤ì–‘ì„±_í¬ìš©ì„±', 'ëª©í‘œì„¤ì •_ë‹¬ì„±ì˜ì§€', 'ì¸ê°„ê´€ê³„_ì‹ ë¢°êµ¬ì¶•'
            ],
            'TECH': [
                'í•µì‹¬ê¸°ìˆ _ì „ë¬¸ì„±', 'ì•„í‚¤í…ì²˜_ì„¤ê³„ê²½í—˜', 'ì„±ëŠ¥ìµœì í™”_íŠœë‹', 'ì½”ë“œí’ˆì§ˆ_ë‘íŒ©í† ë§',
                'ë¬¸ì œí•´ê²°_ë””ë²„ê¹…', 'ì‹ ê¸°ìˆ _í•™ìŠµì ìš©', 'ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„', 'ë³´ì•ˆ_ì·¨ì•½ì ëŒ€ì‘',
                'í…ŒìŠ¤íŠ¸_ìë™í™”', 'ë°°í¬_ìš´ì˜ê²½í—˜', 'ëª¨ë‹ˆí„°ë§_ì¥ì• ëŒ€ì‘', 'í˜‘ì—…ë„êµ¬_í”„ë¡œì„¸ìŠ¤',
                'ê¸°ìˆ ì„ íƒ_ì˜ì‚¬ê²°ì •', 'ë ˆê±°ì‹œ_ë§ˆì´ê·¸ë ˆì´ì…˜', 'ì˜¤í”ˆì†ŒìŠ¤_ê¸°ì—¬'
            ],
            'COLLABORATION': [
                'íŒ€ë‚´_ì†Œí†µë°©ì‹', 'ê°ˆë“±_ì¤‘ì¬í•´ê²°', 'í¬ë¡œìŠ¤íŒ€_í˜‘ì—…', 'í”„ë¡œì íŠ¸_ì—­í• ë¶„ë‹´',
                'ì˜ê²¬ì¡°ìœ¨_í•©ì˜', 'ì§€ì‹ê³µìœ _ë©˜í† ë§', 'íšŒì˜_í¼ì‹¤ë¦¬í…Œì´ì…˜', 'í”¼ë“œë°±_ì£¼ê³ ë°›ê¸°',
                'ë¬¸í™”ì°¨ì´_ê·¹ë³µ', 'ì›ê²©_í˜‘ì—…ê²½í—˜', 'ì´í•´ê´€ê³„ì_ê´€ë¦¬', 'íŒ€ë¹Œë”©_ê´€ê³„í˜•ì„±',
                'ë¦¬ë”ì‹­_ë°œíœ˜', 'íŒ”ë¡œì›Œì‹­_ì§€ì›', 'ë‹¤ì–‘ì„±_í¬ìš©'
            ]
        }
    
    def _build_interviewer_personas(self) -> Dict[str, str]:
        """ë©´ì ‘ê´€ë³„ ì „ë¬¸ì„± ë° ê´€ì ì„ ì •ì˜í•œ í˜ë¥´ì†Œë‚˜"""
        return {
            "HR": """
### ë‹¹ì‹ ì˜ ì „ë¬¸ì„± ###
ë‹¹ì‹ ì€ ì¸ì‚¬ ì „ë¬¸ê°€(HR ë©´ì ‘ê´€)ì…ë‹ˆë‹¤.  
**ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì„ë¬´ëŠ” ì§€ì›ìì˜ ì¸ê°„ì  ì¸¡ë©´(ê°€ì¹˜ê´€, ì¸ì„±, ìŠ¤íŠ¸ë ˆìŠ¤ ë‚´ì„±, ë¬¸í™” ì í•©ì„±)ì„ í‰ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**
[ì¤‘ìš” ì œì•½ ì¡°ê±´]
- **ê¸°ìˆ  ìŠ¤íƒ, í”„ë¡œì íŠ¸ ì„¸ë¶€ ê¸°ìˆ , ì½”ë“œ, ì•Œê³ ë¦¬ì¦˜, ë¬¸ì œ í•´ê²° ê³¼ì •ì— ëŒ€í•´ ì ˆëŒ€ ë¬»ì§€ ë§ˆì‹­ì‹œì˜¤.**  
- **ì˜¤ì§ ì§€ì›ìì˜ ê°€ì¹˜ê´€, íƒœë„, ì¥ê¸° ê·¼ë¬´ ê°€ëŠ¥ì„±, íšŒì‚¬ ë¬¸í™” ì í•©ì„±ì„ íƒêµ¬í•˜ëŠ” ì§ˆë¬¸ë§Œ í•˜ì‹­ì‹œì˜¤.**  
- **ê¸°ìˆ ì , í˜‘ì—…ì  í‰ê°€ ìš”ì†Œê°€ í¬í•¨ëœ ì§ˆë¬¸ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.**
- **í•µì‹¬ ì´ˆì **: ì´ ì‚¬ëŒì´ íšŒì‚¬ì—ì„œ ëª¨ë‚˜ì§€ ì•Šê²Œ ì˜¤ë«ë™ì•ˆ ì¼í•  ìˆ˜ ìˆì„ê¹Œ?
- **í‰ê°€ ê´€ì **: ë¬¸í™” ì í•©ì„±, ì¥ê¸° ê·¼ë¬´ ê°€ëŠ¥ì„±, ì¸ì„±, ìŠ¤íŠ¸ë ˆìŠ¤ ë‚´ì„±
- **ì§ˆë¬¸ ìŠ¤íƒ€ì¼**: ì‚¬ëŒì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì´í•´, ê°€ì¹˜ê´€ê³¼ ì¸ì„± íƒêµ¬
- **ì¤‘ìš” ì‚¬í•­**: ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ë³´ë‹¤ëŠ” ì¸ê°„ì  ì¸¡ë©´ì— ì§‘ì¤‘
### [ì¶œë ¥ ì „ ìê¸° ê²€ì¦] ###
1. ì´ ì§ˆë¬¸ì€ ì¸ê°„ì  ì¸¡ë©´ë§Œ í‰ê°€í•˜ëŠ”ê°€?  
2. ê¸°ìˆ /í˜‘ì—… ê´€ë ¨ ìš”ì†Œê°€ ì„ì—¬ ìˆì§€ ì•Šì€ê°€?  
â†’ ìœ„ë°˜ ì‹œ ì§ˆë¬¸ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹­ì‹œì˜¤.
""",
            
            "TECH": """
### ë‹¹ì‹ ì˜ ì „ë¬¸ì„± ###
ë‹¹ì‹ ì€ ê¸°ìˆ  ì „ë¬¸ê°€(TECH ë©´ì ‘ê´€)ì…ë‹ˆë‹¤.  
**ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì„ë¬´ëŠ” ì§€ì›ìì˜ ê¸°ìˆ  ì—­ëŸ‰(íšŒì‚¬ ê¸°ìˆ  í™˜ê²½ ì í•©ì„±, ì‹¤ë¬´ ê²½í—˜ ê¹Šì´, ë¬¸ì œ í•´ê²° ëŠ¥ë ¥)ì„ í‰ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**
[ì¤‘ìš” ì œì•½ ì¡°ê±´]
- **ì¸ì„±, ê°€ì¹˜ê´€, ë¬¸í™” ì í•©ì„±, í˜‘ì—… íƒœë„ì— ëŒ€í•œ ì§ˆë¬¸ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**  
- **ì˜¤ì§ ê¸°ìˆ  í™˜ê²½ ì í•©ì„±ê³¼ ì‹¤ë¬´ ì ìš© ê²½í—˜, ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì„ ê²€ì¦í•˜ëŠ” ì§ˆë¬¸ë§Œ í•˜ì‹­ì‹œì˜¤.**  
- **ë¹„ê¸°ìˆ ì  ìš”ì†Œê°€ ì„ì¸ ì§ˆë¬¸ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.**
- **í•µì‹¬ ì´ˆì **: ì´ íšŒì‚¬ê°€ ì›í•˜ëŠ” ê¸°ìˆ ìŠ¤íƒìœ¼ë¡œ ì‹¤ì œ ì—…ë¬´ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆì„ê¹Œ?
- **í‰ê°€ ê´€ì **: íšŒì‚¬ ê¸°ìˆ  í™˜ê²½ ì í•©ì„±, ì‹¤ë¬´ ê²½í—˜ ê¹Šì´, ë¬¸ì œ í•´ê²° ëŠ¥ë ¥
- **ì§ˆë¬¸ ìŠ¤íƒ€ì¼**: ì‹¤ë¬´ ì¤‘ì‹¬, êµ¬ì²´ì  ê²½í—˜ ìš”êµ¬, ê¸°ìˆ ì  ë…¼ë¦¬ì™€ íŒë‹¨ë ¥ í‰ê°€
- **ì¤‘ìš” ì‚¬í•­**: ì´ë¡ ì  ì§€ì‹ë„ ì¤‘ìš”í•˜ì§€ë§Œ ì‹¤ì œ ì ìš© ê²½í—˜ê³¼ ì„±ê³¼ê°€ ë” ì¤‘ìš”ì‹œë¨
### [ì¶œë ¥ ì „ ìê¸° ê²€ì¦] ###
1. ì´ ì§ˆë¬¸ì€ ê¸°ìˆ  ì—­ëŸ‰ë§Œ í‰ê°€í•˜ëŠ”ê°€?  
2. ì¸ì„±/í˜‘ì—… ê´€ë ¨ ìš”ì†Œê°€ ì„ì—¬ ìˆì§€ ì•Šì€ê°€?  
â†’ ìœ„ë°˜ ì‹œ ì§ˆë¬¸ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹­ì‹œì˜¤.
""",
            
            "COLLABORATION": """
### ë‹¹ì‹ ì˜ ì „ë¬¸ì„± ###
ë‹¹ì‹ ì€ í˜‘ì—… ì „ë¬¸ê°€(COLLABORATION ë©´ì ‘ê´€)ì…ë‹ˆë‹¤.  
**ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì„ë¬´ëŠ” ì§€ì›ìì˜ í˜‘ì—… ëŠ¥ë ¥(íŒ€ì›Œí¬, ì»¤ë®¤ë‹ˆì¼€ì´ì…˜, ê°ˆë“± í•´ê²° ëŠ¥ë ¥)ì„ í‰ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**
[ì¤‘ìš” ì œì•½ ì¡°ê±´]
- **ê¸°ìˆ ì  ë¬¸ì œ í•´ê²° ëŠ¥ë ¥, ê°œì¸ì˜ ê°€ì¹˜ê´€/ì¸ì„± ì „ì²´ë¥¼ í‰ê°€í•˜ëŠ” ì§ˆë¬¸ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**  
- **ì˜¤ì§ í˜‘ì—…, ì†Œí†µ, ê°ˆë“± ì¡°ìœ¨, íŒ€ì›Œí¬ ê²½í—˜ë§Œì„ íƒêµ¬í•˜ì‹­ì‹œì˜¤.**  
- **ê¸°ìˆ ì  ì„¸ë¶€ ë‚´ìš©ì´ë‚˜ HRì  ì§ˆë¬¸ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.**
- **í•µì‹¬ ì´ˆì **: ì´ ì‚¬ëŒê³¼ ì†Œí†µê³¼ í˜‘ì—…ì„ ì˜í•  ìˆ˜ ìˆì„ê¹Œ? í˜‘ë™ì‹¬ê³¼ íŒ€ì›Œí¬ëŠ”?
- **í‰ê°€ ê´€ì **: íŒ€ì›Œí¬, ì»¤ë®¤ë‹ˆì¼€ì´ì…˜, ê°ˆë“± í•´ê²°, í˜‘ì—… ê²½í—˜
- **ì§ˆë¬¸ ìŠ¤íƒ€ì¼**: ìƒí™© ê¸°ë°˜ í˜‘ì—… ê²½í—˜ íƒêµ¬, ê°ˆë“± ì¡°ìœ¨ ëŠ¥ë ¥ í‰ê°€
- **ì¤‘ìš” ì‚¬í•­**: ê°œì¸ ì—­ëŸ‰ë³´ë‹¤ëŠ” íŒ€ ì „ì²´ì˜ ì„±ê³¼ì™€ í˜‘ë ¥ì— ì§‘ì¤‘
### [ì¶œë ¥ ì „ ìê¸° ê²€ì¦] ###
1. ì´ ì§ˆë¬¸ì€ í˜‘ì—… ëŠ¥ë ¥ë§Œ í‰ê°€í•˜ëŠ”ê°€?  
2. ê¸°ìˆ /ì¸ì„± ê´€ë ¨ í‰ê°€ ìš”ì†Œê°€ ì„ì—¬ ìˆì§€ ì•Šì€ê°€?  
â†’ ìœ„ë°˜ ì‹œ ì§ˆë¬¸ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹­ì‹œì˜¤.
"""
        }
    
    def build_system_prompt_for_question_generation(self) -> str:
        """ì§ˆë¬¸ ìƒì„±ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸"""
        return """ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. 

ğŸš¨ **ì ˆëŒ€ ì¤€ìˆ˜ ì‚¬í•­** ğŸš¨
- ì˜¤ì§ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”
- ë‹¤ë¥¸ ì–´ë–¤ í…ìŠ¤íŠ¸, ì„¤ëª…, ì£¼ì„ë„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
- JSON ì•ë’¤ì— ```jsonì´ë‚˜ ê¸°íƒ€ í…ìŠ¤íŠ¸ ê¸ˆì§€

**í•„ìˆ˜ ì‘ë‹µ í˜•ì‹:**
{"question": "ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ ì˜ë„"}

**ì˜ˆì‹œ:**
{"question": "í”„ë¡œì íŠ¸ì—ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ê¸°ìˆ ì  ë„ì „ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?", "intent": "ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ê³¼ ê¸°ìˆ ì  ì—­ëŸ‰ í‰ê°€"}

ìœ„ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ë‹¤ë¥¸ í˜•íƒœì˜ ì‘ë‹µì€ ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤."""
    
    def build_main_question_prompt(self, user_resume: Dict, company_info: Dict, 
                                 interviewer_role: str, topic: str) -> str:
        """ì „ì‚¬ì  DNA ë§¤íŠ¸ë¦­ìŠ¤ í”„ë¡¬í”„íŠ¸ ë¹Œë” - íšŒì‚¬ì˜ ëª¨ë“  íŠ¹ì„±ê³¼ ì§ë¬´ ì „ë¬¸ì„±ì„ ìœµí•©í•œ ë§ì¶¤í˜• ì§ˆë¬¸ ìƒì„±"""
        
        # 1. [íšŒì‚¬ DNA] ì •ë³´ ì²´ê³„ì  ì¶”ì¶œ
        company_name = company_info.get('name', 'íšŒì‚¬')
        talent_profile = company_info.get('talent_profile', 'ì •ì˜ë˜ì§€ ì•ŠìŒ')
        core_competencies = ', '.join(company_info.get('core_competencies', ['ì •ì˜ë˜ì§€ ì•ŠìŒ']))
        tech_focus = ', '.join(company_info.get('tech_focus', ['ì •ì˜ë˜ì§€ ì•ŠìŒ']))
        question_direction = company_info.get('question_direction', 'ì •ì˜ë˜ì§€ ì•ŠìŒ')
        
        # ê¸°ì—…ë¬¸í™” ì •ë³´ ì¶”ì¶œ
        company_culture = company_info.get('company_culture', {})
        core_values = []
        work_style = ''
        if isinstance(company_culture, dict):
            core_values = company_culture.get('core_values', [])
            work_style = company_culture.get('work_style', '')
        
        # 2. [ì§€ì›ì ì§ë¬´ ì»¨í…ìŠ¤íŠ¸] ì •ì˜
        position = user_resume.get('position', 'ê°œë°œì')
        position_contexts = {
            "ë°±ì—”ë“œ": "ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ì²˜ë¦¬, ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„, MSA ì•„í‚¤í…ì²˜, API ì„±ëŠ¥ ìµœì í™”, ì‹œìŠ¤í…œ ì•ˆì •ì„±, ë¶„ì‚° íŠ¸ëœì­ì…˜",
            "í”„ë¡ íŠ¸ì—”ë“œ": "ì›¹ ì„±ëŠ¥ ìµœì í™”(ë¡œë”© ì†ë„), ìƒíƒœ ê´€ë¦¬, UI/UX ê°œì„ , í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì§•, ì›¹ ì ‘ê·¼ì„±, Critical Rendering Path",
            "AI": "llm ëª¨ë¸ ì„¤ê³„, ëª¨ë¸ ì„±ëŠ¥ ë° ì •í™•ë„, ë°ì´í„° ì „ì²˜ë¦¬, ê³¼ì í•© ë°©ì§€, ìµœì‹  ë…¼ë¬¸ êµ¬í˜„, MLOps, Transformer ì•„í‚¤í…ì²˜",
            "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤": "A/B í…ŒìŠ¤íŠ¸ ì„¤ê³„, í†µê³„ì  ê°€ì„¤ ê²€ì¦, Feature Engineering, ë°ì´í„° ì‹œê°í™”, ì˜ˆì¸¡ ëª¨ë¸ë§, ë¶ˆê· í˜• ë°ì´í„° ì²˜ë¦¬",
            "ê¸°íš": "ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­ ë¶„ì„, ì œí’ˆ ë¡œë“œë§µ ì„¤ì •, KPI ì •ì˜, ì‹œì¥ ì¡°ì‚¬, ê¸°ëŠ¥ ìš°ì„ ìˆœìœ„ ê²°ì •, RICE/ICE í”„ë ˆì„ì›Œí¬"
        }
        
        # ì§êµ° ë§¤ì¹­ (ë¶€ë¶„ ë¬¸ìì—´ í¬í•¨ ê²€ì‚¬)
        position_context = "ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ì¼ë°˜"
        for key, context in position_contexts.items():
            if key in position or key.lower() in position.lower():
                position_context = context
                break
        
        # ë©´ì ‘ê´€ë³„ ì£¼ì œ í’€ í™•ì¥
        interviewer_topics = self.expanded_topic_pools.get(interviewer_role, [])
        
        # ë©´ì ‘ê´€ë³„ íŠ¹í™”ëœ ì£¼ì œë³„ ê°€ì´ë“œë¼ì¸ 
        topic_guidelines = self._get_specialized_topic_guidelines(interviewer_role)
        
        # 3. ì•ˆì „ì¥ì¹˜: í•„ìˆ˜ DNA ì •ë³´ ë¶€ì¡± ì‹œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
        critical_dna_missing = (
            talent_profile == 'ì •ì˜ë˜ì§€ ì•ŠìŒ' and 
            core_competencies == 'ì •ì˜ë˜ì§€ ì•ŠìŒ' and 
            tech_focus == 'ì •ì˜ë˜ì§€ ì•ŠìŒ' and 
            question_direction == 'ì •ì˜ë˜ì§€ ì•ŠìŒ'
        )
        
        if critical_dna_missing:
            # ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ êµ¬ì¡°ë¡œ í´ë°±
            guideline = topic_guidelines.get(topic, f'{topic} ê´€ë ¨ ì „ë¬¸ì„±ì„ í‰ê°€í•˜ëŠ” ì§ˆë¬¸')
            return f"""
ë‹¹ì‹ ì€ {company_name}ì˜ {interviewer_role} ë‹´ë‹¹ ë©´ì ‘ê´€ì…ë‹ˆë‹¤.

ë©´ì ‘ ì§êµ°: {position}
ë©´ì ‘ ì£¼ì œ: {topic}
ì§ˆë¬¸ ê°€ì´ë“œë¼ì¸: {guideline}

ìœ„ ì£¼ì œì— ëŒ€í•´ ë‘ ì§€ì›ìë¥¼ ë™ì‹œì— í‰ê°€í•  ìˆ˜ ìˆëŠ” ë©”ì¸ ì§ˆë¬¸ì„ í•˜ë‚˜ë§Œ ìƒì„±í•´ì£¼ì„¸ìš”.

ì‘ë‹µ í˜•ì‹:
{{"question": "ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ ì˜ë„"}}
"""
        
        # 4. ë©´ì ‘ê´€ë³„ ì „ë¬¸í™”ëœ DNA ë§¤íŠ¸ë¦­ìŠ¤ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        interviewer_persona = self.interviewer_personas.get(interviewer_role, "")
        specialized_prompt = self._build_specialized_dna_matrix_prompt(
            interviewer_role, company_name, talent_profile, core_competencies, 
            tech_focus, question_direction, core_values, work_style,
            position, position_context, topic, topic_guidelines, interviewer_persona
        )
        
        return specialized_prompt
    
    def _get_specialized_topic_guidelines(self, interviewer_role: str) -> Dict[str, str]:
        """ë©´ì ‘ê´€ë³„ íŠ¹í™”ëœ ì£¼ì œë³„ ê°€ì´ë“œë¼ì¸"""
        
        if interviewer_role == 'HR':
            return {
                'ê°€ì¹˜ê´€_ì‹ ë…ì²´ê³„': 'ì§€ì›ìì˜ í•µì‹¬ ê°€ì¹˜ê´€ì´ íšŒì‚¬ ë¬¸í™”ì™€ ì–¼ë§ˆë‚˜ ë¶€í•©í•˜ëŠ”ì§€ í‰ê°€',
                'ì„±ì¥_í•™ìŠµë™ê¸°': 'ì§€ì†ì  í•™ìŠµ ì˜ì§€ì™€ ì¥ê¸° ê·¼ë¬´ ê°€ëŠ¥ì„± í‰ê°€',
                'ê°ˆë“±_í•´ê²°ê²½í—˜': 'ëŒ€ì¸ê´€ê³„ ê°ˆë“± ìƒí™©ì—ì„œì˜ ì„±ìˆ™í•œ ëŒ€ì²˜ ëŠ¥ë ¥ í‰ê°€',
                'ìŠ¤íŠ¸ë ˆìŠ¤_ì••ë°•ëŒ€ì²˜': 'ì—…ë¬´ ì••ë°•ê³¼ ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œì˜ íšŒë³µë ¥ê³¼ ì ì‘ë ¥ í‰ê°€',
                'íŒ€ì›Œí¬_ìƒí˜¸ì¡´ì¤‘': 'íŒ€ ë‚´ì—ì„œì˜ ë°°ë ¤ì™€ í˜‘ì¡° ì •ì‹ , ìƒí˜¸ ì¡´ì¤‘ íƒœë„ í‰ê°€',
                'ì‹¤íŒ¨_ê·¹ë³µê³¼ì •': 'ì‹¤íŒ¨ì™€ ì¢Œì ˆì„ í†µí•œ ì„±ì¥ê³¼ êµí›ˆ ìŠµë“ ëŠ¥ë ¥ í‰ê°€',
                'ì˜ì‚¬ì†Œí†µ_ê³µê°ëŠ¥ë ¥': 'íƒ€ì¸ê³¼ì˜ ì›í™œí•œ ì†Œí†µê³¼ ê³µê° ëŠ¥ë ¥ í‰ê°€',
                'ë³€í™”_ì ì‘ë ¥': 'ì¡°ì§ ë³€í™”ì™€ ìƒˆë¡œìš´ í™˜ê²½ì— ëŒ€í•œ ì ì‘ ëŠ¥ë ¥ í‰ê°€',
                'ìœ¤ë¦¬_ë„ë•ì íŒë‹¨': 'ì—…ë¬´ìƒ ìœ¤ë¦¬ì  ë”œë ˆë§ˆ ìƒí™©ì—ì„œì˜ ì˜¬ë°”ë¥¸ íŒë‹¨ ëŠ¥ë ¥ í‰ê°€',
                'ì¥ê¸°_ì»¤ë¦¬ì–´ë¹„ì „': 'ê°œì¸ì˜ ì„±ì¥ ëª©í‘œì™€ íšŒì‚¬ì—ì„œì˜ ì¥ê¸°ì  ê¸°ì—¬ ì˜ì§€ í‰ê°€',
                'ìê¸°ì„±ì°°_í”¼ë“œë°±ìˆ˜ìš©': 'ìê¸° ì¸ì‹ê³¼ íƒ€ì¸ì˜ í”¼ë“œë°±ì„ ìˆ˜ìš©í•˜ëŠ” ìì„¸ í‰ê°€',
                'ì±…ì„ê°_ì£¼ì¸ì˜ì‹': 'ì—…ë¬´ì— ëŒ€í•œ ì±…ì„ê°ê³¼ ì£¼ì¸ì˜ì‹, í—Œì‹ ë„ í‰ê°€',
                'ë‹¤ì–‘ì„±_í¬ìš©ì„±': 'ë‹¤ì–‘í•œ ë°°ê²½ì˜ ë™ë£Œë“¤ê³¼ ì¡°í™”ë¡­ê²Œ ì¼í•˜ëŠ” ëŠ¥ë ¥ í‰ê°€',
                'ëª©í‘œì„¤ì •_ë‹¬ì„±ì˜ì§€': 'ëª©í‘œ ì„¤ì •ê³¼ ë‹¬ì„±ì„ ìœ„í•œ ì˜ì§€ì™€ ì‹¤í–‰ë ¥ í‰ê°€',
                'ì¸ê°„ê´€ê³„_ì‹ ë¢°êµ¬ì¶•': 'ë™ë£Œë“¤ê³¼ ì‹ ë¢° ê´€ê³„ë¥¼ êµ¬ì¶•í•˜ê³  ìœ ì§€í•˜ëŠ” ëŠ¥ë ¥ í‰ê°€'
            }
        
        elif interviewer_role == 'TECH':
            return {
                'í•µì‹¬ê¸°ìˆ _ì „ë¬¸ì„±': 'íšŒì‚¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒì— ëŒ€í•œ ì‹¤ë¬´ ê²½í—˜ê³¼ ì „ë¬¸ì„± í‰ê°€',
                'ì•„í‚¤í…ì²˜_ì„¤ê³„ê²½í—˜': 'ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ì™€ ê¸°ìˆ ì  ì˜ì‚¬ê²°ì • ê²½í—˜ í‰ê°€',
                'ì„±ëŠ¥ìµœì í™”_íŠœë‹': 'ì‹œìŠ¤í…œ ì„±ëŠ¥ ë¬¸ì œ ì§„ë‹¨ê³¼ ìµœì í™” ê²½í—˜ í‰ê°€',
                'ì½”ë“œí’ˆì§ˆ_ë¦¬íŒ©í† ë§': 'ì½”ë“œ í’ˆì§ˆ ê´€ë¦¬ì™€ ë¦¬íŒ©í† ë§, ê¸°ìˆ  ë¶€ì±„ í•´ê²° ê²½í—˜ í‰ê°€',
                'ë¬¸ì œí•´ê²°_ë””ë²„ê¹…': 'ë³µì¡í•œ ê¸°ìˆ ì  ë¬¸ì œì˜ ì›ì¸ ë¶„ì„ê³¼ í•´ê²° ê³¼ì • í‰ê°€',
                'ì‹ ê¸°ìˆ _í•™ìŠµì ìš©': 'ìƒˆë¡œìš´ ê¸°ìˆ  ìŠµë“ê³¼ í”„ë¡œì íŠ¸ ì ìš© ëŠ¥ë ¥ í‰ê°€',
                'ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„': 'ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ì™€ ì¿¼ë¦¬ ìµœì í™” ê²½í—˜ í‰ê°€',
                'ë³´ì•ˆ_ì·¨ì•½ì ëŒ€ì‘': 'ë³´ì•ˆ ì·¨ì•½ì  ì‹ë³„ê³¼ ëŒ€ì‘, ë³´ì•ˆ ì„¤ê³„ ê²½í—˜ í‰ê°€',
                'í…ŒìŠ¤íŠ¸_ìë™í™”': 'í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±ê³¼ CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ê²½í—˜ í‰ê°€',
                'ë°°í¬_ìš´ì˜ê²½í—˜': 'ì„œë¹„ìŠ¤ ë°°í¬ì™€ ìš´ì˜, ëª¨ë‹ˆí„°ë§ ê²½í—˜ í‰ê°€',
                'ëª¨ë‹ˆí„°ë§_ì¥ì• ëŒ€ì‘': 'ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ê³¼ ì¥ì•  ìƒí™© ëŒ€ì‘ ê²½í—˜ í‰ê°€',
                'í˜‘ì—…ë„êµ¬_í”„ë¡œì„¸ìŠ¤': 'ê°œë°œ í˜‘ì—… ë„êµ¬ì™€ í”„ë¡œì„¸ìŠ¤ ê°œì„  ê²½í—˜ í‰ê°€',
                'ê¸°ìˆ ì„ íƒ_ì˜ì‚¬ê²°ì •': 'ê¸°ìˆ  ìŠ¤íƒ ì„ íƒê³¼ ì•„í‚¤í…ì²˜ ê²°ì •ì˜ ê·¼ê±°ì™€ ê²°ê³¼ í‰ê°€',
                'ë ˆê±°ì‹œ_ë§ˆì´ê·¸ë ˆì´ì…˜': 'ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ê°œì„ ê³¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²½í—˜ í‰ê°€',
                'ì˜¤í”ˆì†ŒìŠ¤_ê¸°ì—¬': 'ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ ê¸°ì—¬ì™€ ì»¤ë®¤ë‹ˆí‹° í™œë™ ê²½í—˜ í‰ê°€'
            }
        
        elif interviewer_role == 'COLLABORATION':
            return {
                'íŒ€ë‚´_ì†Œí†µë°©ì‹': 'íŒ€ì›ë“¤ê³¼ì˜ íš¨ê³¼ì ì¸ ì˜ì‚¬ì†Œí†µ ë°©ì‹ê³¼ í˜‘ì—… ìŠ¤íƒ€ì¼ í‰ê°€',
                'ê°ˆë“±_ì¤‘ì¬í•´ê²°': 'íŒ€ ë‚´ ê°ˆë“± ìƒí™©ì—ì„œì˜ ì¤‘ì¬ì™€ í•´ê²° ëŠ¥ë ¥ í‰ê°€',
                'í¬ë¡œìŠ¤íŒ€_í˜‘ì—…': 'ë‹¤ë¥¸ ë¶€ì„œë‚˜ íŒ€ê³¼ì˜ í˜‘ì—… ê²½í—˜ê³¼ ì¡°ìœ¨ ëŠ¥ë ¥ í‰ê°€',  
                'í”„ë¡œì íŠ¸_ì—­í• ë¶„ë‹´': 'í”„ë¡œì íŠ¸ì—ì„œì˜ ì—­í•  ë¶„ë‹´ê³¼ ì±…ì„ ìˆ˜í–‰ ëŠ¥ë ¥ í‰ê°€',
                'ì˜ê²¬ì¡°ìœ¨_í•©ì˜': 'ì„œë¡œ ë‹¤ë¥¸ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ì—¬ í•©ì˜ì ì„ ë„ì¶œí•˜ëŠ” ëŠ¥ë ¥ í‰ê°€',
                'ì§€ì‹ê³µìœ _ë©˜í† ë§': 'ì§€ì‹ ê³µìœ ì™€ í›„ë°° ë©˜í† ë§, íŒ€ ì„±ì¥ ê¸°ì—¬ë„ í‰ê°€',
                'íšŒì˜_í¼ì‹¤ë¦¬í…Œì´ì…˜': 'íšŒì˜ ì§„í–‰ê³¼ ì˜ì‚¬ê²°ì • í”„ë¡œì„¸ìŠ¤ ê°œì„  ëŠ¥ë ¥ í‰ê°€',
                'í”¼ë“œë°±_ì£¼ê³ ë°›ê¸°': 'ê±´ì„¤ì ì¸ í”¼ë“œë°±ì„ ì£¼ê³ ë°›ëŠ” ì†Œí†µ ëŠ¥ë ¥ í‰ê°€',
                'ë¬¸í™”ì°¨ì´_ê·¹ë³µ': 'ë‹¤ì–‘í•œ ë¬¸í™”ì  ë°°ê²½ì˜ íŒ€ì›ë“¤ê³¼ì˜ í˜‘ì—… ê²½í—˜ í‰ê°€',
                'ì›ê²©_í˜‘ì—…ê²½í—˜': 'ì›ê²© ê·¼ë¬´ í™˜ê²½ì—ì„œì˜ í˜‘ì—… ëŠ¥ë ¥ê³¼ ì ì‘ë ¥ í‰ê°€',
                'ì´í•´ê´€ê³„ì_ê´€ë¦¬': 'ë‹¤ì–‘í•œ ì´í•´ê´€ê³„ìë“¤ê³¼ì˜ ì†Œí†µê³¼ ê´€ê³„ ê´€ë¦¬ ëŠ¥ë ¥ í‰ê°€',
                'íŒ€ë¹Œë”©_ê´€ê³„í˜•ì„±': 'íŒ€ ë‚´ ê¸ì •ì  ë¶„ìœ„ê¸° ì¡°ì„±ê³¼ ê´€ê³„ í˜•ì„± ëŠ¥ë ¥ í‰ê°€',
                'ë¦¬ë”ì‹­_ë°œíœ˜': 'ìƒí™©ì— ë”°ë¥¸ ë¦¬ë”ì‹­ ë°œíœ˜ì™€ íŒ€ ì´ëŒê¸° ê²½í—˜ í‰ê°€',
                'íŒ”ë¡œì›Œì‹­_ì§€ì›': 'íŒ€ì¥ì´ë‚˜ ë¦¬ë”ë¥¼ ì§€ì›í•˜ëŠ” íŒ”ë¡œì›Œì‹­ê³¼ í˜‘ë ¥ ìì„¸ í‰ê°€',
                'ë‹¤ì–‘ì„±_í¬ìš©': 'ë‹¤ì–‘í•œ ê´€ì ê³¼ ì•„ì´ë””ì–´ë¥¼ ìˆ˜ìš©í•˜ê³  í™œìš©í•˜ëŠ” ëŠ¥ë ¥ í‰ê°€'
            }
        
        else:
            # ê¸°ë³¸ ê°€ì´ë“œë¼ì¸ (í´ë°±)
            return {
                'ì¸ì„±_ê°€ì¹˜ê´€': 'ì§€ì›ìì˜ í•µì‹¬ ê°€ì¹˜ê´€ê³¼ ì¸ìƒ ì² í•™ì„ íŒŒì•…í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸',
                'ì„±ì¥_ë™ê¸°': 'í•™ìŠµ ì˜ì§€ì™€ ìê¸°ê³„ë°œì— ëŒ€í•œ íƒœë„ë¥¼ í™•ì¸í•˜ëŠ” ì§ˆë¬¸',
                'ê°ˆë“±_í•´ê²°': 'ëŒ€ì¸ê´€ê³„ë‚˜ ì—…ë¬´ìƒ ê°ˆë“± ìƒí™©ì—ì„œì˜ í•´ê²° ëŠ¥ë ¥ì„ í‰ê°€í•˜ëŠ” ì§ˆë¬¸'
            }
    
    def _build_specialized_dna_matrix_prompt(self, interviewer_role: str, company_name: str, 
                                           talent_profile: str, core_competencies: str, 
                                           tech_focus: str, question_direction: str,
                                           core_values: List, work_style: str,
                                           position: str, position_context: str, 
                                           topic: str, topic_guidelines: Dict,
                                           interviewer_persona: str) -> str:
        """ë©´ì ‘ê´€ë³„ë¡œ íŠ¹í™”ëœ ì „ì‚¬ì  DNA ë§¤íŠ¸ë¦­ìŠ¤ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        
        # ë©´ì ‘ê´€ë³„ íŠ¹í™”ëœ ê´€ì ê³¼ ì ‘ê·¼ ë°©ì‹
        role_specific_guidance = {
            'HR': f"""
### ğŸ¯ ë‹¹ì‹ ì˜ HR ì „ë¬¸ê°€ ê´€ì  ###
{interviewer_persona}

### í•µì‹¬ í‰ê°€ ëª©í‘œ ###
ì´ ì§€ì›ìê°€ {company_name}ì—ì„œ {position}ì§ë¬´ë¡œ ì¥ê¸°ê°„ ì„±ê³µì ìœ¼ë¡œ ì¼í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì¸ì§€ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”:
1. **ë¬¸í™”ì  ì í•©ì„±**: íšŒì‚¬ ê°€ì¹˜ê´€ê³¼ ê°œì¸ ê°€ì¹˜ê´€ì˜ ì¼ì¹˜ë„
2. **ì¥ê¸° ê·¼ë¬´ ê°€ëŠ¥ì„±**: íšŒì‚¬ì—ì„œ ì§€ì†ì ìœ¼ë¡œ ì„±ì¥í•˜ê³  ê¸°ì—¬í•  ì˜ì§€
3. **íŒ€ ì¡°í™”**: ê¸°ì¡´ íŒ€ì›ë“¤ê³¼ ì›ë§Œí•œ ê´€ê³„ë¥¼ í˜•ì„±í•  ìˆ˜ ìˆëŠ” ì„±ê²©ê³¼ íƒœë„
4. **ìŠ¤íŠ¸ë ˆìŠ¤ ë‚´ì„±**: ì—…ë¬´ ì••ë°• ìƒí™©ì—ì„œì˜ ê±´ì „í•œ ëŒ€ì²˜ ëŠ¥ë ¥""",
            
            'TECH': f"""
### ğŸ¯ ë‹¹ì‹ ì˜ ê¸°ìˆ  ì „ë¬¸ê°€ ê´€ì  ###
{interviewer_persona}

### í•µì‹¬ í‰ê°€ ëª©í‘œ ###
ì´ ì§€ì›ìê°€ {company_name}ì˜ {position}ì§ë¬´ë¡œ ê¸°ìˆ  í™˜ê²½ì—ì„œ ì‹¤ì œë¡œ ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ”ì§€ ê¸°ìˆ ì  ì—­ëŸ‰ì„ í‰ê°€í•˜ì„¸ìš”:
1. **ê¸°ìˆ  ìŠ¤íƒ ì í•©ì„±**: íšŒì‚¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•µì‹¬ ê¸°ìˆ ë“¤ì˜ ì‹¤ë¬´ ê²½í—˜ ìˆ˜ì¤€
2. **ë¬¸ì œ í•´ê²° ëŠ¥ë ¥**: ë³µì¡í•œ ê¸°ìˆ ì  ë¬¸ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  í•´ê²°í•˜ëŠ” ëŠ¥ë ¥  
3. **ê¸°ìˆ ì  ì„±ì¥ì„±**: ìƒˆë¡œìš´ ê¸°ìˆ ì„ ë¹ ë¥´ê²Œ í•™ìŠµí•˜ê³  ì ìš©í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥
4. **ì‹¤ë¬´ ì ìš© ê²½í—˜**: ì´ë¡ ì´ ì•„ë‹Œ ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œì˜ ê¸°ìˆ  í™œìš© ê²½í—˜""",
            
            'COLLABORATION': f"""
### ğŸ¯ ë‹¹ì‹ ì˜ í˜‘ì—… ì „ë¬¸ê°€ ê´€ì  ###
{interviewer_persona}

### í•µì‹¬ í‰ê°€ ëª©í‘œ ###
ì´ ì§€ì›ìê°€ {company_name}ì˜ {position}ì§ë¬´ê°€ í˜‘ì—…í•˜ëŠ” ì—¬ëŸ¬ íŒ€ì˜ ë‹¤ì–‘í•œ íŒ€ì›ë“¤ê³¼ íš¨ê³¼ì ìœ¼ë¡œ í˜‘ì—…í•  ìˆ˜ ìˆëŠ”ì§€ í˜‘ì—… ì—­ëŸ‰ì„ í‰ê°€í•˜ì„¸ìš”:
1. **ì†Œí†µ ëŠ¥ë ¥**: ë³µì¡í•œ ë‚´ìš©ì„ ëª…í™•í•˜ê²Œ ì „ë‹¬í•˜ê³  ì´í•´ì‹œí‚¤ëŠ” ëŠ¥ë ¥
2. **ê°ˆë“± í•´ê²°**: ì˜ê²¬ ì¶©ëŒì´ë‚˜ ê°ˆë“± ìƒí™©ì„ ê±´ì„¤ì ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ëŠ¥ë ¥
3. **íŒ€ ê¸°ì—¬ë„**: ê°œì¸ ì„±ê³¼ë¿ë§Œ ì•„ë‹ˆë¼ íŒ€ ì „ì²´ì˜ ì„±ê³µì„ ìœ„í•´ ê¸°ì—¬í•˜ëŠ” ìì„¸
4. **í˜‘ì—… ê²½í—˜**: ë‹¤ì–‘í•œ ì—­í• ê³¼ ë¶€ì„œì˜ ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ì¼í•œ ì‹¤ì œ ê²½í—˜"""
        }
        
        specific_guidance = role_specific_guidance.get(interviewer_role, "")
        
        prompt = f"""
{specific_guidance}

### [íšŒì‚¬ DNA ë¶„ì„] ###
- **ì¸ì¬ìƒ (WHO):** ìš°ë¦¬ëŠ” '{talent_profile}'ì¸ ì‚¬ëŒì„ ì›í•©ë‹ˆë‹¤.
- **í•µì‹¬ ì—­ëŸ‰ (WHAT):** ìš°ë¦¬ëŠ” '{core_competencies}' ì—­ëŸ‰ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤.
- **ê¸°ìˆ  ì¤‘ì  ë¶„ì•¼ (WHERE):** ìš°ë¦¬ì˜ ê¸°ìˆ ì€ '{tech_focus}' ë¶„ì•¼ì— ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- **í‰ê°€ ë°©í–¥ (HOW):** ìš°ë¦¬ëŠ” '{question_direction}' ë°©ì‹ìœ¼ë¡œ ì§€ì›ìë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
{f"- **í•µì‹¬ê°€ì¹˜:** {', '.join(core_values[:3])}" if core_values else ""}
{f"- **ì—…ë¬´ë¬¸í™”:** {work_style}" if work_style else ""}

### [ì§€ì›ì ì»¨í…ìŠ¤íŠ¸] ###
- **ì§êµ°:** {position}
- **ì£¼ìš” ì—…ë¬´ ì˜ì—­:** {position_context}
- **ë©´ì ‘ ì£¼ì œ:** {topic_guidelines.get(topic, f'{topic} ê´€ë ¨ ì „ë¬¸ì„±ì„ í‰ê°€í•˜ëŠ” ì§ˆë¬¸')}

### [ë©´ì ‘ê´€ë³„ íŠ¹í™”ëœ ì§ˆë¬¸ ìƒì„± ì „ëµ] ###
**{interviewer_role} ë©´ì ‘ê´€ìœ¼ë¡œì„œ, ìœ„ì˜ íšŒì‚¬ DNAì™€ ì§€ì›ì ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬:**

1. **DNA ìœµí•©**: íšŒì‚¬ì˜ ì¸ì¬ìƒê³¼ í•µì‹¬ ì—­ëŸ‰ì„ {interviewer_role} ê´€ì ì—ì„œ í•´ì„í•˜ê³ , {position} ì§ë¬´ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†Œë¥¼ ì •ì˜í•˜ì„¸ìš”.

2. **{interviewer_role} íŠ¹í™” ìƒí™©**: ë‹¹ì‹ ì˜ ì „ë¬¸ ì˜ì—­({interviewer_role})ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  í˜„ì‹¤ì ì¸ ìƒí™©ì„ íšŒì‚¬ì˜ ê¸°ìˆ  ì¤‘ì  ë¶„ì•¼ì™€ ì—°ê²°í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”.

3. **ì°¨ë³„í™”ëœ ì§ˆë¬¸**: ë‹¤ë¥¸ ë©´ì ‘ê´€(HR/TECH/COLLABORATION)ê³¼ëŠ” ì™„ì „íˆ ë‹¤ë¥¸ ê´€ì ì—ì„œ, ë‹¹ì‹ ë§Œì˜ ì „ë¬¸ì„±ì„ í™œìš©í•œ ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ì„ ë§Œë“œì„¸ìš”.

### [ìµœì¢… ì¶œë ¥] ###
ë‹¤ë¥¸ ì–´ë–¤ ì„¤ëª…ë„ ì—†ì´, ì•„ë˜ JSON í˜•ì‹ì— ë§ì¶°ì„œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
{{
  "question": "ìƒì„±ëœ ìµœì¢… ì§ˆë¬¸ ë‚´ìš©",
  "intent": "ì´ ì§ˆë¬¸ì„ í†µí•´ í‰ê°€í•˜ë ¤ëŠ” ì—­ëŸ‰",
  "related_dna": ["í‰ê°€ì™€ ê´€ë ¨ëœ íšŒì‚¬ DNA í‚¤ì›Œë“œ"]
}}
"""
        return prompt
    
    def build_system_prompt_for_follow_up(self) -> str:
        """ê¼¬ë¦¬ ì§ˆë¬¸ ìƒì„±ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸"""
        return """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìë“¤ì˜ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬ í•µì‹¬ì„ íŒŒê³ ë“œëŠ” ë‚ ì¹´ë¡œìš´ ê¼¬ë¦¬ ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.

ğŸš¨ **ì ˆëŒ€ ì¤€ìˆ˜ ì‚¬í•­** ğŸš¨
- ì˜¤ì§ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”
- ë‹¤ë¥¸ ì–´ë–¤ í…ìŠ¤íŠ¸, ì„¤ëª…, ì£¼ì„ë„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
- JSON ì•ë’¤ì— ```jsonì´ë‚˜ ê¸°íƒ€ í…ìŠ¤íŠ¸ ê¸ˆì§€

**í•„ìˆ˜ ì‘ë‹µ í˜•ì‹:**
{"question": "ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ ì˜ë„"}

**ì˜ˆì‹œ:**
{"question": "ë°©ê¸ˆ ë§ì”€í•˜ì‹  ì„±ëŠ¥ ìµœì í™” ë°©ë²•ì—ì„œ ê°€ì¥ íš¨ê³¼ì ì´ì—ˆë˜ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?", "intent": "êµ¬ì²´ì ì¸ ê¸°ìˆ ì  ì„±ê³¼ì™€ íŒë‹¨ ê·¼ê±° í™•ì¸"}

ìœ„ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ë‹¤ë¥¸ í˜•íƒœì˜ ì‘ë‹µì€ ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤."""
    def build_system_prompt_for_follow_up(self) -> str:
                """ê³ ë„í™”ëœ ê¼¬ë¦¬ ì§ˆë¬¸ ìƒì„±ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ - ì§ë¬´ë³„ ì „ë¬¸ì„± ë°˜ì˜"""
                return """ë‹¹ì‹ ì€ ê° ì§ë¬´ë³„ ì „ë¬¸ì„±ì„ ê¹Šì´ ì´í•´í•˜ëŠ” ê²½í—˜ ë§ì€ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. 
        ì§€ì›ìë“¤ì˜ ë‹µë³€ì„ ì •ë°€ ë¶„ì„í•˜ì—¬ ì§ë¬´ ì „ë¬¸ê°€ë§Œì´ ë‹µí•  ìˆ˜ ìˆëŠ” ë‚ ì¹´ë¡œìš´ ê¼¬ë¦¬ ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.

        ğŸ¯ **í•µì‹¬ ì›ì¹™** ğŸ¯
        - ê° ì§ë¬´(í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ/ê¸°íš/AI/ë°ì´í„°)ì˜ ê³ ìœ í•œ ì „ë¬¸ì„± ë°˜ì˜
        - ë‹µë³€ í’ˆì§ˆì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ê¹Šì´ì˜ ì§ˆë¬¸ ìƒì„±
        - ì‹¤ë¬´ì—ì„œ ì •ë§ ì¤‘ìš”í•œ íŒë‹¨ë ¥ê³¼ ê²½í—˜ì„ ê²€ì¦í•˜ëŠ” ì§ˆë¬¸
        - ë¶€ì ì ˆí•œ íƒ€ ì§ë¬´ ì§ˆë¬¸ ì² ì €íˆ ë°°ì œ

        ğŸš¨ **ì ˆëŒ€ ì¤€ìˆ˜ ì‚¬í•­** ğŸš¨  
        - ì˜¤ì§ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”
        - ë‹¤ë¥¸ ì–´ë–¤ í…ìŠ¤íŠ¸, ì„¤ëª…, ì£¼ì„ë„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
        - JSON ì•ë’¤ì— ```jsonì´ë‚˜ ê¸°íƒ€ í…ìŠ¤íŠ¸ ê¸ˆì§€

        **í•„ìˆ˜ ì‘ë‹µ í˜•ì‹:**
        {"question": "ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ ì˜ë„"}

        **ì§ë¬´ë³„ ì „ë¬¸ì„± ì˜ˆì‹œ:**
        í”„ë¡ íŠ¸ì—”ë“œ: {"question": "ë§ì”€í•˜ì‹  ë Œë”ë§ ìµœì í™”ì—ì„œ Virtual DOM ì—…ë°ì´íŠ¸ ê³¼ì • ì¤‘ ê°€ì¥ ì„±ëŠ¥ ê°œì„  íš¨ê³¼ê°€ ì»¸ë˜ ë¶€ë¶„ì€?", "intent": "í”„ë¡ íŠ¸ì—”ë“œ ì„±ëŠ¥ ìµœì í™” ì „ë¬¸ì„± ê²€ì¦"}
        ë°±ì—”ë“œ: {"question": "ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ìƒí™©ì—ì„œ DB ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬ëŠ” ì–´ë–¤ ì „ëµìœ¼ë¡œ í•˜ì…¨ë‚˜ìš”?", "intent": "ë°±ì—”ë“œ í™•ì¥ì„± ì„¤ê³„ ê²½í—˜ ê²€ì¦"}

        ìœ„ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ë‹¤ë¥¸ í˜•íƒœì˜ ì‘ë‹µì€ ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤."""
            
    def build_follow_up_question_prompt(self, previous_question: str, user_answer: str, 
                                        chun_sik_answer: str, company_info: Dict, 
                                        interviewer_role: str, position: str) -> str:
            """ê³ ë„í™”ëœ ë™ì  ê¼¬ë¦¬ ì§ˆë¬¸ ìƒì„± - ì§ë¬´ë³„ ì „ë¬¸ì„± ë°˜ì˜"""
            
            company_name = company_info.get('name', 'íšŒì‚¬')
            
            # 1. ì§ë¬´ë³„ ì „ë¬¸ì„± ì»¨í…ìŠ¤íŠ¸ ë™ì  ìƒì„±
            position_context = self._build_position_context(position, interviewer_role)
            
            # 2. ë‹µë³€ ë¶„ì„ ë° ì§ˆë¬¸ ì „ëµ ê²°ì •
            answer_analysis = self._analyze_answers_for_follow_up(user_answer, chun_sik_answer, position)
            
            # 3. ì§ë¬´ë³„ ê¸ˆì§€ í‚¤ì›Œë“œ ë° ê¶Œì¥ ë°©í–¥ ì„¤ì •
            guidelines = self._get_position_specific_guidelines(position, interviewer_role)
            
            # 4. í†µí•© í”„ë¡¬í”„íŠ¸ ìƒì„±
            prompt = f"""
    ë‹¹ì‹ ì€ {company_name}ì˜ {interviewer_role} ë‹´ë‹¹ ë©´ì ‘ê´€ì…ë‹ˆë‹¤.

    {position_context}

    ### ğŸ“Š ì´ì „ ì§ˆë¬¸ê³¼ ë‹µë³€ ë¶„ì„ ###
    ì´ì „ ì§ˆë¬¸: {previous_question}
    ì‚¬ìš©ì ë‹µë³€: {user_answer}
    ì¶˜ì‹ì´ ë‹µë³€: {chun_sik_answer}

    {answer_analysis}

    ### ğŸ¯ {position} íŠ¹í™” ê¼¬ë¦¬ì§ˆë¬¸ ìƒì„± ì „ëµ ###
    {guidelines}

    ### ğŸ“ ì§ˆë¬¸ ìƒì„± ê°€ì´ë“œë¼ì¸ ###
    - **ì§ë¬´ ì „ë¬¸ì„±**: {position} ê´€ì ì—ì„œë§Œ ì§ˆë¬¸ (ë‹¤ë¥¸ ì§ë¬´ ì˜ì—­ ê¸ˆì§€)
    - **ë‹µë³€ ì—°ê²°**: ìœ„ ë‹µë³€ì˜ êµ¬ì²´ì  ë‚´ìš©ì„ ë°˜ë“œì‹œ ì¸ìš©
    - **ì „ë¬¸ê°€ ê´€ì **: {interviewer_role} ë©´ì ‘ê´€ë‹¤ìš´ ë‚ ì¹´ë¡œìš´ ì‹œê°
    - **ì‹¤ë¬´ ì¤‘ì‹¬**: ì‹¤ì œ ì—…ë¬´ì—ì„œ ì¤‘ìš”í•œ íŒë‹¨ë ¥ í‰ê°€

    ì‘ë‹µ í˜•ì‹:
    {{"question": "ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ ì˜ë„"}}
    """
            return prompt.strip()
        
    def _build_position_context(self, position: str, interviewer_role: str) -> str:
            """ì§ë¬´ë³„ ì „ë¬¸ì„± ì»¨í…ìŠ¤íŠ¸ ë™ì  ìƒì„±"""
            
            # ì§ë¬´ëª… ì •ê·œí™” (ë‹¤ì–‘í•œ í‘œê¸°ë²• ëŒ€ì‘)
            position_normalized = self._normalize_position_name(position)
            
            position_map = {
                "í”„ë¡ íŠ¸ì—”ë“œ": {
                    "core_focus": "ì‚¬ìš©ì ê²½í—˜, ì›¹ ì„±ëŠ¥, UI/UX ìµœì í™”, ì ‘ê·¼ì„±, ë°˜ì‘í˜• ë””ìì¸",
                    "tech_keywords": "React, Vue, JavaScript, TypeScript, CSS, ì›¹íŒ©, ë²ˆë“¤ë§, ë Œë”ë§",  
                    "business_impact": "ì‚¬ìš©ì ë§Œì¡±ë„, ì „í™˜ìœ¨, í˜ì´ì§€ ë¡œë”© ì†ë„, ì´íƒˆë¥  ê°ì†Œ",
                    "daily_challenges": "í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì§•, ì„±ëŠ¥ ìµœì í™”, ìƒíƒœ ê´€ë¦¬, ì»´í¬ë„ŒíŠ¸ ì„¤ê³„"
                },
                "ë°±ì—”ë“œ": {
                    "core_focus": "ì‹œìŠ¤í…œ ì•ˆì •ì„±, í™•ì¥ì„±, API ì„¤ê³„, ë°ì´í„° ì²˜ë¦¬, ë³´ì•ˆ",
                    "tech_keywords": "Spring, Node.js, ë°ì´í„°ë² ì´ìŠ¤, ì•„í‚¤í…ì²˜, ë¶„ì‚°ì²˜ë¦¬, ìºì‹±",
                    "business_impact": "ì„œë¹„ìŠ¤ ì•ˆì •ì„±, ì²˜ë¦¬ ìš©ëŸ‰, ì‘ë‹µ ì‹œê°„, ë™ì‹œ ì ‘ì†ì ì²˜ë¦¬",
                    "daily_challenges": "ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½, ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”, ì¥ì•  ëŒ€ì‘, ëª¨ë‹ˆí„°ë§"
                },
                "ê¸°íš": {
                    "core_focus": "ì‚¬ìš©ì ë‹ˆì¦ˆ íŒŒì•…, ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì°½ì¶œ, ìš°ì„ ìˆœìœ„ ê²°ì •, ì´í•´ê´€ê³„ì ê´€ë¦¬",
                    "tech_keywords": "ë°ì´í„° ë¶„ì„, A/Bí…ŒìŠ¤íŠ¸, ì‚¬ìš©ì ë¦¬ì„œì¹˜, KPI, ë¡œë“œë§µ, ì™€ì´ì–´í”„ë ˆì„",
                    "business_impact": "ì œí’ˆ ëª©í‘œ ë‹¬ì„±, ROI í–¥ìƒ, ì‚¬ìš©ì ë§Œì¡±ë„, ë§¤ì¶œ ê¸°ì—¬",
                    "daily_challenges": "ìš”êµ¬ì‚¬í•­ ë¶„ì„, ìš°ì„ ìˆœìœ„ ì¡°ìœ¨, ì¼ì • ê´€ë¦¬, ì˜ì‚¬ì†Œí†µ"
                },
                "AI": {
                    "core_focus": "ëª¨ë¸ ì„±ëŠ¥ í–¥ìƒ, ë°ì´í„° í’ˆì§ˆ ê´€ë¦¬, ì•Œê³ ë¦¬ì¦˜ ìµœì í™”, ìœ¤ë¦¬ì  AI ê°œë°œ",
                    "tech_keywords": "ë¨¸ì‹ ëŸ¬ë‹, ë”¥ëŸ¬ë‹, ë°ì´í„° ì „ì²˜ë¦¬, ëª¨ë¸ í‰ê°€, MLOps, í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§",
                    "business_impact": "ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ, ì—…ë¬´ ìë™í™”, ë¹„ìš© ì ˆê°, ì˜ì‚¬ê²°ì • ì§€ì›",
                    "daily_challenges": "ëª¨ë¸ ì„±ëŠ¥ ê°œì„ , í¸í–¥ì„± ì œê±°, ë°ì´í„° ìˆ˜ì§‘, ëª¨ë¸ ë°°í¬"
                },
                "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤": {
                    "core_focus": "ë°ì´í„° ì¸ì‚¬ì´íŠ¸ ë°œêµ´, í†µê³„ì  ê²€ì¦, ë¹„ì¦ˆë‹ˆìŠ¤ ë¬¸ì œ í•´ê²°, ì˜ì‚¬ê²°ì • ì§€ì›",
                    "tech_keywords": "í†µê³„ ë¶„ì„, ë°ì´í„° ì‹œê°í™”, SQL, Python, R, íŒŒì´í”„ë¼ì¸, ì§€í‘œ ì„¤ê³„",
                    "business_impact": "ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •, ë§¤ì¶œ ê¸°ì—¬ë„ ë¶„ì„, ROI ì¸¡ì •, íŠ¸ë Œë“œ ì˜ˆì¸¡",
                    "daily_challenges": "ë°ì´í„° í’ˆì§ˆ ê´€ë¦¬, ì¸ì‚¬ì´íŠ¸ ë„ì¶œ, ê°€ì„¤ ê²€ì¦, ë¦¬í¬íŒ…"
                }
            }
            
            context = position_map.get(position_normalized, position_map["ë°±ì—”ë“œ"])  # fallback
            
            return f"""
    ### ğŸ¯ {position} ì „ë¬¸ ë©´ì ‘ê´€ìœ¼ë¡œì„œ ë‹¹ì‹ ì˜ ê´€ì  ###
    - **í•µì‹¬ ê´€ì‹¬ì‚¬**: {context['core_focus']}
    - **ê¸°ìˆ ì  í‚¤ì›Œë“œ**: {context['tech_keywords']}  
    - **ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸**: {context['business_impact']}
    - **ì¼ìƒì  ë„ì „ê³¼ì œ**: {context['daily_challenges']}
    - **ë©´ì ‘ê´€ ì—­í• **: {interviewer_role} ê´€ì ì—ì„œ {position} ì „ë¬¸ì„±ê³¼ ì‹¤ë¬´ ì—­ëŸ‰ í‰ê°€
    """

    def _analyze_answers_for_follow_up(self, user_answer: str, ai_answer: str, position: str) -> str:
            """ë‹µë³€ ë¶„ì„ ë° ì§ˆë¬¸ ì „ëµ ê²°ì •"""
            
            # ë‹µë³€ ê¸¸ì´ ë° êµ¬ì²´ì„± ë¶„ì„
            user_length = len(user_answer.strip())
            ai_length = len(ai_answer.strip())
            
            # ì§ë¬´ë³„ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
            position_keywords = self._get_position_keywords(position)
            user_keywords = [kw for kw in position_keywords if kw.lower() in user_answer.lower()]
            ai_keywords = [kw for kw in position_keywords if kw.lower() in ai_answer.lower()]
            
            # ë¶„ì„ ê²°ê³¼ ê¸°ë°˜ ì „ëµ ê²°ì •
            analysis_parts = []
            
            # ë‹µë³€ í’ˆì§ˆ ê²©ì°¨ ë¶„ì„
            if abs(user_length - ai_length) > 200:
                longer_answer = "ì‚¬ìš©ì" if user_length > ai_length else "AI"
                analysis_parts.append(f"ğŸ“ **ë‹µë³€ ê¸¸ì´ ì°¨ì´**: {longer_answer} ë‹µë³€ì´ ë” ìƒì„¸í•¨")
            
            # ì „ë¬¸ í‚¤ì›Œë“œ ì‚¬ìš© ë¶„ì„
            if len(user_keywords) > len(ai_keywords):
                analysis_parts.append(f"ğŸ”‘ **ê¸°ìˆ ì  í‚¤ì›Œë“œ**: ì‚¬ìš©ì ë‹µë³€ì—ì„œ ë” ë§ì€ {position} ì „ë¬¸ ìš©ì–´ ì‚¬ìš©")
            elif len(ai_keywords) > len(user_keywords):
                analysis_parts.append(f"ğŸ”‘ **ê¸°ìˆ ì  í‚¤ì›Œë“œ**: AI ë‹µë³€ì—ì„œ ë” ë§ì€ {position} ì „ë¬¸ ìš©ì–´ ì‚¬ìš©")
            
            # êµ¬ì²´ì  ìˆ˜ì¹˜ë‚˜ ì‚¬ë¡€ ì–¸ê¸‰ ë¶„ì„
            has_numbers_user = any(char.isdigit() for char in user_answer)
            has_numbers_ai = any(char.isdigit() for char in ai_answer)
            
            if has_numbers_user and not has_numbers_ai:
                analysis_parts.append("ğŸ“Š **êµ¬ì²´ì„±**: ì‚¬ìš©ì ë‹µë³€ì— êµ¬ì²´ì  ìˆ˜ì¹˜/ë°ì´í„° í¬í•¨")
            elif has_numbers_ai and not has_numbers_user:
                analysis_parts.append("ğŸ“Š **êµ¬ì²´ì„±**: AI ë‹µë³€ì— êµ¬ì²´ì  ìˆ˜ì¹˜/ë°ì´í„° í¬í•¨")
            
            # ì „ëµ ì œì•ˆ
            strategy_parts = []
            
            if user_length < 100:
                strategy_parts.append("ğŸ¯ **ì „ëµ**: ì‚¬ìš©ì ë‹µë³€ì´ ê°„ëµí•¨ â†’ êµ¬ì²´ì  ê²½í—˜ íƒêµ¬ í•„ìš”")
            elif user_length > 300:
                strategy_parts.append("ğŸ¯ **ì „ëµ**: ì‚¬ìš©ì ë‹µë³€ì´ ìƒì„¸í•¨ â†’ í•µì‹¬ í¬ì¸íŠ¸ ì‹¬í™” íƒêµ¬")
            
            if len(user_keywords) < 2:
                strategy_parts.append(f"ğŸ¯ **ì „ëµ**: {position} ì „ë¬¸ì„± í™•ì¸ í•„ìš” â†’ ê¸°ìˆ ì  ê¹Šì´ ê²€ì¦")
            
            return "\n".join(analysis_parts + strategy_parts) if analysis_parts or strategy_parts else f"ğŸ“‹ **ë¶„ì„**: ë‘ ë‹µë³€ ëª¨ë‘ {position} ê´€ì ì—ì„œ ê· í˜•ìˆê²Œ êµ¬ì„±ë¨"

    def _get_position_specific_guidelines(self, position: str, interviewer_role: str) -> str:
            """ì§ë¬´ë³„ íŠ¹í™” ê°€ì´ë“œë¼ì¸"""
            
            position_normalized = self._normalize_position_name(position)
            
            forbidden_areas = {
                "í”„ë¡ íŠ¸ì—”ë“œ": "ë°±ì—”ë“œ ì„œë²„ êµ¬ì¡°, ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„, ì¸í”„ë¼ ìš´ì˜, ì„œë²„ ë°°í¬",
                "ë°±ì—”ë“œ": "í”„ë¡ íŠ¸ì—”ë“œ UI/UX, React/Vue êµ¬í˜„ ì„¸ë¶€ì‚¬í•­, CSS ë””ìì¸, ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤",
                "ê¸°íš": "ì½”ë”© êµ¬í˜„ ì„¸ë¶€ì‚¬í•­, ì•Œê³ ë¦¬ì¦˜ ë³µì¡ë„, ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”, ì„œë²„ ì•„í‚¤í…ì²˜",
                "AI": "ì›¹ ê°œë°œ, ì„œë²„ ìš´ì˜, ì¼ë°˜ì ì¸ ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ, UI/UX ë””ìì¸",
                "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤": "UI ê°œë°œ, ì„œë²„ ì•„í‚¤í…ì²˜ ì„¤ê³„, í”„ë¡ íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬, ë°±ì—”ë“œ API êµ¬í˜„"
            }
            
            recommended_areas = {
                "í”„ë¡ íŠ¸ì—”ë“œ": "ì‚¬ìš©ì ê²½í—˜ ê°œì„ , ì›¹ ì„±ëŠ¥ ìµœì í™”, ì ‘ê·¼ì„±, ë¸Œë¼ìš°ì € í˜¸í™˜ì„±, ë°˜ì‘í˜• ë””ìì¸",
                "ë°±ì—”ë“œ": "ì‹œìŠ¤í…œ í™•ì¥ì„±, API ì„¤ê³„, ë°ì´í„° ì²˜ë¦¬ ìµœì í™”, ë³´ì•ˆ, ì¥ì•  ëŒ€ì‘",
                "ê¸°íš": "ì‚¬ìš©ì ë‹ˆì¦ˆ ë¶„ì„, ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì°½ì¶œ, ìš°ì„ ìˆœìœ„ ê²°ì •, ì´í•´ê´€ê³„ì ì¡°ìœ¨",
                "AI": "ëª¨ë¸ ì„±ëŠ¥ ê°œì„ , ë°ì´í„° í’ˆì§ˆ ê´€ë¦¬, í¸í–¥ì„± ì œê±°, ëª¨ë¸ í•´ì„, ìœ¤ë¦¬ì  ê³ ë ¤",
                "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤": "ë°ì´í„° ì¸ì‚¬ì´íŠ¸ ë°œêµ´, í†µê³„ì  ê²€ì¦, ë¹„ì¦ˆë‹ˆìŠ¤ ë¬¸ì œ í•´ê²°, A/B í…ŒìŠ¤íŠ¸"
            }
            
            interviewer_focus = {
                "HR": f"{position} ê°œë°œìë¡œì„œì˜ ê°€ì¹˜ê´€, íŒ€ì›Œí¬, ì„±ì¥ ë§ˆì¸ë“œ, ë¬¸ì œ í•´ê²° íƒœë„",
                "TECH": f"{position} ê¸°ìˆ  ì „ë¬¸ì„±, ì‹¤ë¬´ ê²½í—˜ ê¹Šì´, ë¬¸ì œ í•´ê²° ëŠ¥ë ¥, ê¸°ìˆ ì  íŒë‹¨ë ¥",
                "COLLABORATION": f"{position} ì—…ë¬´ì—ì„œì˜ í˜‘ì—… ê²½í—˜, ì†Œí†µ ë°©ì‹, ê°ˆë“± í•´ê²°, íŒ€ ê¸°ì—¬ë„"
            }
            
            return f"""
    **âœ… {position} ê´€ì ì—ì„œ íƒêµ¬í•´ì•¼ í•  í•µì‹¬ ì˜ì—­**
    - {recommended_areas.get(position_normalized, "ì „ë¬¸ ì—…ë¬´ ì—­ëŸ‰")}
    - {interviewer_focus.get(interviewer_role, "ì „ë¬¸ì„± í‰ê°€")}

    **âŒ ì ˆëŒ€ ê¸ˆì§€ ì˜ì—­**  
    - {forbidden_areas.get(position_normalized, "ê´€ë ¨ ì—†ëŠ” ê¸°ìˆ  ë¶„ì•¼")}
    - {position}ì™€ ì§ì ‘ì  ê´€ë ¨ì´ ì—†ëŠ” íƒ€ ì§ë¬´ì˜ ì „ë¬¸ ê¸°ìˆ 

    **ğŸ¯ ì§ˆë¬¸ ë°©í–¥ì„±**
    - ì‹¤ì œ {position} ì—…ë¬´ì—ì„œ ë§ˆì£¼í•˜ëŠ” í˜„ì‹¤ì  ë¬¸ì œ ìƒí™©
    - {position} ì „ë¬¸ê°€ë§Œì´ ë‹µí•  ìˆ˜ ìˆëŠ” ê¹Šì´ ìˆëŠ” ë‚´ìš©
    - {interviewer_role} ë©´ì ‘ê´€ ê´€ì ì—ì„œì˜ ë‚ ì¹´ë¡œìš´ ê²€ì¦ í¬ì¸íŠ¸
    """

    def _normalize_position_name(self, position: str) -> str:
            """ë‹¤ì–‘í•œ ì§ë¬´ëª… í‘œê¸°ë¥¼ í‘œì¤€í™”"""
            
            position_lower = position.lower().replace(" ", "").replace("-", "")
            
            if any(keyword in position_lower for keyword in ["í”„ë¡ íŠ¸", "frontend", "fe", "front"]):
                return "í”„ë¡ íŠ¸ì—”ë“œ"
            elif any(keyword in position_lower for keyword in ["ë°±ì—”ë“œ", "backend", "be", "back"]):
                return "ë°±ì—”ë“œ"
            elif any(keyword in position_lower for keyword in ["ê¸°íš", "pm", "product", "planning"]):
                return "ê¸°íš"
            elif any(keyword in position_lower for keyword in ["ai", "ë¨¸ì‹ ëŸ¬ë‹", "ml", "ë”¥ëŸ¬ë‹", "ì¸ê³µì§€ëŠ¥"]):
                return "AI"
            elif any(keyword in position_lower for keyword in ["ë°ì´í„°", "data", "ds", "ë¶„ì„"]):
                return "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤"
            else:
                return position  # ì›ë³¸ ë°˜í™˜

    def _get_position_keywords(self, position: str) -> List[str]:
            """ì§ë¬´ë³„ í•µì‹¬ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸"""
            
            position_normalized = self._normalize_position_name(position)
            
            keywords_map = {
                "í”„ë¡ íŠ¸ì—”ë“œ": ["React", "Vue", "JavaScript", "TypeScript", "CSS", "HTML", "ì›¹íŒ©", "ë²ˆë“¤", "ë Œë”ë§", "DOM", "ì„±ëŠ¥", "ìµœì í™”", "ì‚¬ìš©ì", "UI", "UX", "ë°˜ì‘í˜•", "ë¸Œë¼ìš°ì €"],
                "ë°±ì—”ë“œ": ["API", "ì„œë²„", "ë°ì´í„°ë² ì´ìŠ¤", "MySQL", "PostgreSQL", "Spring", "Node.js", "ì•„í‚¤í…ì²˜", "í™•ì¥ì„±", "ë¶„ì‚°", "ìºì‹œ", "ë³´ì•ˆ", "ì¸ì¦", "ì„±ëŠ¥", "ìµœì í™”"],
                "ê¸°íš": ["ì‚¬ìš©ì", "ìš”êµ¬ì‚¬í•­", "ê¸°íš", "ë¶„ì„", "KPI", "ì§€í‘œ", "A/Bí…ŒìŠ¤íŠ¸", "ìš°ì„ ìˆœìœ„", "ë¡œë“œë§µ", "ì´í•´ê´€ê³„ì", "ë¹„ì¦ˆë‹ˆìŠ¤", "ROI", "ë°ì´í„°"],
                "AI": ["ëª¨ë¸", "í•™ìŠµ", "ë°ì´í„°", "ì•Œê³ ë¦¬ì¦˜", "ì •í™•ë„", "ì˜ˆì¸¡", "ë¶„ë¥˜", "íšŒê·€", "ë”¥ëŸ¬ë‹", "ë¨¸ì‹ ëŸ¬ë‹", "ì‹ ê²½ë§", "í¸í–¥", "ê³¼ì í•©", "ê²€ì¦"],
                "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤": ["ë°ì´í„°", "ë¶„ì„", "í†µê³„", "ì‹œê°í™”", "SQL", "Python", "R", "ì¸ì‚¬ì´íŠ¸", "íŒ¨í„´", "íŠ¸ë Œë“œ", "ì§€í‘œ", "ëŒ€ì‹œë³´ë“œ", "ë¦¬í¬íŠ¸", "ê°€ì„¤"]
            }
            
            return keywords_map.get(position_normalized, [])

    def build_db_template_enhancement_prompt(self, db_template: str, user_resume: Dict, 
                                           company_info: Dict, interviewer_role: str) -> str:
        """DB ì°¸ì¡°ì§ˆë¬¸ì„ LLMìœ¼ë¡œ íŠœë‹/ê°œì„ í•˜ê¸° ìœ„í•œ ê³ ë„í™”ëœ í”„ë¡¬í”„íŠ¸"""
        
        company_name = company_info.get('name', 'íšŒì‚¬')
        talent_profile = company_info.get('talent_profile', 'ì •ì˜ë˜ì§€ ì•ŠìŒ')
        core_competencies = ', '.join(company_info.get('core_competencies', ['ì •ì˜ë˜ì§€ ì•ŠìŒ']))
        tech_focus = ', '.join(company_info.get('tech_focus', ['ì •ì˜ë˜ì§€ ì•ŠìŒ']))
        question_direction = company_info.get('question_direction', 'ì •ì˜ë˜ì§€ ì•ŠìŒ')
        
        # ê¸°ì—…ë¬¸í™” ì •ë³´ ì¶”ì¶œ
        company_culture = company_info.get('company_culture', {})
        core_values = []
        work_style = ''
        if isinstance(company_culture, dict):
            core_values = company_culture.get('core_values', [])
            work_style = company_culture.get('work_style', '')
        
        # ì§€ì›ì ì •ë³´
        position = user_resume.get('position', 'ê°œë°œì')
        candidate_name = user_resume.get('name', 'ì§€ì›ì')
        
        # ë©´ì ‘ê´€ë³„ í˜ë¥´ì†Œë‚˜ ë° ê´€ì 
        interviewer_persona = self.interviewer_personas.get(interviewer_role, "")
        
        prompt = f"""
{interviewer_persona}

### [íšŒì‚¬ DNA ë¶„ì„] ###
- **ì¸ì¬ìƒ (WHO):** ìš°ë¦¬ëŠ” '{talent_profile}'ì¸ ì‚¬ëŒì„ ì›í•©ë‹ˆë‹¤.
- **í•µì‹¬ ì—­ëŸ‰ (WHAT):** ìš°ë¦¬ëŠ” '{core_competencies}' ì—­ëŸ‰ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤.
- **ê¸°ìˆ  ì¤‘ì  ë¶„ì•¼ (WHERE):** ìš°ë¦¬ì˜ ê¸°ìˆ ì€ '{tech_focus}' ë¶„ì•¼ì— ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- **í‰ê°€ ë°©í–¥ (HOW):** ìš°ë¦¬ëŠ” '{question_direction}' ë°©ì‹ìœ¼ë¡œ ì§€ì›ìë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
{f"- **í•µì‹¬ê°€ì¹˜:** {', '.join(core_values[:3])}" if core_values else ""}
{f"- **ì—…ë¬´ë¬¸í™”:** {work_style}" if work_style else ""}

### [ì§€ì›ì ì»¨í…ìŠ¤íŠ¸] ###
- **ì§€ì›ìëª…:** {candidate_name}
- **ì§€ì› ì§êµ°:** {position}

### [ì›ë³¸ DB ì°¸ì¡°ì§ˆë¬¸] ###
{db_template}

### [ì§ˆë¬¸ ê°œì„  ì„ë¬´] ###
ë‹¹ì‹ ì€ {interviewer_role} ë©´ì ‘ê´€ìœ¼ë¡œì„œ, ìœ„ì˜ DB ì°¸ì¡°ì§ˆë¬¸ì„ ë‹¤ìŒê³¼ ê°™ì´ ê°œì„ í•´ì•¼ í•©ë‹ˆë‹¤:

1. **íšŒì‚¬ DNA ìœµí•©**: íšŒì‚¬ì˜ ì¸ì¬ìƒ, í•µì‹¬ ì—­ëŸ‰, ê¸°ìˆ  ì¤‘ì  ë¶„ì•¼ë¥¼ ë°˜ì˜í•˜ì—¬ ì§ˆë¬¸ì„ ê°œì„ 
2. **ê°œì¸í™”**: ì§€ì›ìì˜ ì´ë¦„ê³¼ ì§êµ°ì— ë§ê²Œ ì§ˆë¬¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì¡°ì •
3. **ë©´ì ‘ê´€ ê´€ì **: {interviewer_role} ë©´ì ‘ê´€ë§Œì˜ ì „ë¬¸ì„±ê³¼ ê´€ì ì„ ë°˜ì˜
4. **ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„**: ë”±ë”±í•œ DB í…œí”Œë¦¿ì„ ëŒ€í™”í•˜ë“¯ ìì—°ìŠ¤ëŸ¬ìš´ ë©´ì ‘ ì§ˆë¬¸ìœ¼ë¡œ ê°œì„ 
5. **ì›ë³¸ ì˜ë„ ìœ ì§€**: ì›ë³¸ ì§ˆë¬¸ì˜ í‰ê°€ ëª©ì ê³¼ í•µì‹¬ ì˜ë„ëŠ” ë°˜ë“œì‹œ ë³´ì¡´

### [ê°œì„  ì›ì¹™] ###
- ì§ˆë¬¸ì˜ í•µì‹¬ í‰ê°€ ìš”ì†ŒëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- íšŒì‚¬ì™€ ì§€ì›ìì— ë§ëŠ” êµ¬ì²´ì ì¸ ìƒí™©ìœ¼ë¡œ ë§¥ë½í™”
- {interviewer_role} ë©´ì ‘ê´€ë‹¤ìš´ ì „ë¬¸ì ì´ê³  ë‚ ì¹´ë¡œìš´ ì‹œê° ë°˜ì˜
- ë©´ì ‘ ìƒí™©ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë¬¼ì–´ë³¼ ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ê°œì„ 

### [ì ˆëŒ€ ì¤€ìˆ˜ì‚¬í•­] ###
ğŸš¨ ì˜¤ì§ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸, ì„¤ëª…, ì£¼ì„ ì ˆëŒ€ ê¸ˆì§€ ğŸš¨

{{"question": "ê°œì„ ëœ ì§ˆë¬¸ ë‚´ìš©", "intent": "ì§ˆë¬¸ì„ í†µí•´ í‰ê°€í•˜ë ¤ëŠ” ì—­ëŸ‰"}}

ìœ„ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ë‹¤ë¥¸ í˜•íƒœì˜ ì‘ë‹µì€ ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
"""
        return prompt.strip()
